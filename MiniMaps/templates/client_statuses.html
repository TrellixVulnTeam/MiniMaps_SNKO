{% extends 'base.html' %}

{% block content %}
    <!--Client table-->
    <h2><strong>{{ title }}</strong></h2>
    <hr>
    <!--Status count container-->
    <div class="container-fluid">
        <div class="row">
            {% for k, v in counts.items() %}
                {% set backgroundColor = status_colors.get(k, 'white') %}
                {% set textColor = text_colors.get(k, 'black') %}
                <div class="col-sm-4" style="
                        background-color: {{ backgroundColor }};
                        color: {{ textColor }};">    
                    <strong>{{ k }}</strong>: {{ v }}
                </div>
            {% endfor %}
        </div>
    </div>
    <br>

    <!--Auto refresh page script-->
    <script src="/static/autoRefresh.js"></script>
{% endblock %}

<!--Set background and text color based on days late-->
{% macro percent(n) %}
    {{ "{}%".format(n) }}
{% endmacro %}
{% macro style_color(days, late_days=2) %}
    {% if days %}
        {% set red = ((days|int * 1.5)/255 * 100)|int %}
        {% set green = 50 - red %}
        style="background-color: RGB({{ percent(red) }}, {{ percent(green) }}, 0%); color: white;"
    {% endif %}
{% endmacro %}

<!--Table content-->
{% block table %}
    <table id="BrioClientTable" class="display" width="100%" cellspacing="0">
        <thead>
            <th>Client</th>
            <th>Status</th>
            <!--<th>Instance URL</th>-->
            <th>Assignee</th>
            <th>ETA</th>
            <th>Notes</th>
            <th>Created</th>
            <!--<th>Updated</th>-->
            <th>Queue Days</th>
            <th>Days Since Last Update</th>
        </thead>

        <tbody>
        {% for index, row in data.iterrows() %}
            {% set name = row['name'] %}
            {% set status = row['status'] %}
            {% set instance_url = row['instance_url'] %}
            {% set assignee = row['assignee'] %}
            {% set eta = row['estimated_completion'] %}
            {% set notes = row['import_notes'] %}
            {% set created = row['created_timestamp'] %}
            {% set updated = row['updated_timestamp'] %}
            {% set queue_days = row['queue_days'] %}
            {% set update_days = row['update_days'] %}

            {% set backgroundColor = status_colors.get(status, 'white') %}
            {% set textColor = text_colors[status] %}
            <tr>
                <td><a href="{{ instance_url if instance_url else url_for('client_statuses') }}">
                    {{ name }}
                    </a>
                </td>
                <td style="
                        background-color: {{ backgroundColor }};
                        color: {{ textColor }};">
                    {{ status if status else "" }}
                </td>
                <td>{{ assignee if assignee else "" }}</td>
                <td>{{ eta if eta else "" }}</td>
                <td><a href="{{ url_for('full_note', note=notes) }}">{{ notes[:18] + "..." if notes else ""}}</a></td>
                <td>{{ created if created else "" }}</td>
                <!--<td>{{ updated if updated else "" }}</td>-->
                <td {{ style_color(queue_days) }}>
                    {{ queue_days if queue_days else "" }}
                </td>
                <td {{ style_color(update_days) }}>
                    {{ update_days if update_days else "" }}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

     <script>
        $(document).ready(function() {
            $('#BrioClientTable').DataTable( {
                "order" : [[5, "asc"],
                            [7, "desc"]]
            } );
        })
    </script>

{% endblock %}